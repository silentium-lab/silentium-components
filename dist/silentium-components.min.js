!function(e,t){"use strict";function i(e){return t.Message((function(){const i=t.Primitive(e).primitive();t.isFilled(i)&&this.use(i)}))}var s=Object.defineProperty,n=(e,t,i)=>((e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);class r{constructor(e,i=[],s=[],r){this.$base=e,this.keep=i,this.exclude=s,n(this,"$comparing",t.Late()),n(this,"cloner"),this.cloner=void 0===r?e=>JSON.parse(JSON.stringify(e)):r}pipe(e){const i=t.Applied(this.$comparing,this.cloner);return t.All(i,this.$base).pipe(t.Tap((([t,i])=>{t&&e.use(Object.fromEntries(Object.entries(t).filter((([e,t])=>!!this.keep.includes(e)||!this.exclude.includes(e)&&t!==i[e]))))}))),this}use(e){return this.$comparing.use(e),this}}var u=Object.defineProperty,o=(e,t,i)=>((e,t,i)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);class p{constructor(e,i){o(this,"$base"),o(this,"$keyed"),this.$base=t.SharedSource(e),this.$keyed=t.Shared(i)}pipe(e){return t.All(this.$base,this.$keyed).pipe(t.Tap((([t,i])=>{const s=i.split(".");let n=t;s.forEach((e=>{n=n[e]})),void 0!==n&&n!==t&&e.use(n)}))),this}use(e){const i=t.Primitive(this.$keyed);if(t.isFilled(i)){const s=t.Primitive(this.$base);this.$base.use({...s.primitiveWithException(),[i.primitiveWithException()]:e})}return this}}function a(e){return t.Message((function(){const i=Object.keys(e);i.forEach((i=>{t.isMessage(e[i])||(e[i]=t.Of(e[i]))})),t.All(...Object.values(e)).pipe(t.Tap((e=>{const t={};e.forEach(((e,s)=>{t[i[s]]=e})),this.use(t)})))}))}var c=Object.defineProperty,l=(e,t,i)=>((e,t,i)=>t in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);class f{constructor(e=t.Of(""),i=t.Of({})){this.$src=e,this.$places=i,l(this,"dc",t.DestroyContainer()),l(this,"vars",{$TPL:t.Of("$TPL")})}pipe(e){const i=a(this.vars);return t.Applied(t.All(this.$src,this.$places,i),(([e,t,i])=>(Object.entries(t).forEach((([t,i])=>{e=e.replaceAll(t,String(i))})),Object.entries(i).forEach((([t,i])=>{e=e.replaceAll(t,String(i))})),e))).pipe(e),this}template(e){this.$src=t.Of(e)}var(e){const i=`$var${Object.keys(this.vars).length}`;return t.isDestroyable(e)&&this.dc.add(e),this.vars[i]=e,i}destroy(){return this.dc.destroy(),this}}function h(e,i,s=t.Of("")){return t.Message((function(){t.All(e,i,s).pipe(t.Tap((([e,t,i])=>{this.use(new RegExp(e,i).test(t))})))}))}e.And=function(e,i){return t.Message((function(){t.All(e,i).pipe(t.Tap((([e,t])=>{this.use(!(!e||!t))})))}))},e.Bool=function(e){return t.Message((function(){t.Applied(e,Boolean).pipe(this)}))},e.Branch=function(e,i,s){const n=t.ActualMessage(e),r=t.ActualMessage(i),u=s&&t.ActualMessage(s);return t.Message((function(){const e=t.Primitive(r);let i;void 0!==u&&(i=t.Primitive(u)),n.pipe(t.Tap((t=>{let s=null;t?s=e.primitive():i&&(s=i.primitive()),null!==s&&this.use(s)})))}))},e.BranchLazy=function(e,i,s){return t.Message((function(){const n=t.DestroyContainer(),r=()=>{n.destroy()};return e.pipe(t.Tap((e=>{let t;r(),e?t=i.use():s&&(t=s.use()),void 0!==t&&(t.pipe(this),n.add(t))}))),r}))},e.Concatenated=function(e,i=t.Of("")){return t.Message((function(){t.All(i,...e).pipe(t.Tap((([e,...t])=>{this.use(t.join(e))})))}))},e.Constant=function(e,i){return t.Message((function(){i.pipe(t.Tap((()=>{this.use(e)})))}))},e.Deadline=function(e,i,s){const n=t.ActualMessage(s);return t.Message((function(){let s=0;const r=t.Shared(i,!0);n.pipe(t.Tap((i=>{s&&clearTimeout(s);let n=!1;s=setTimeout((()=>{n||(n=!0,e.use(new Error("Timeout reached in Deadline")))}),i);t.Filtered(r,(()=>!n)).pipe(this),r.pipe(t.Tap((()=>{n=!0})))})))}))},e.Deferred=function(e,i){return t.Message((function(){const s=t.Primitive(e);i.pipe(t.Tap((()=>{const e=s.primitive();t.isFilled(e)&&this.use(e)})))}))},e.Detached=i,e.Dirty=function(e,t=[],i=[],s){return new r(e,t,i,s)},e.First=function(e){return t.Message((function(){t.Applied(e,(e=>e[0])).pipe(this)}))},e.FromJson=function(e,i){return t.Message((function(){e.pipe(t.Tap((e=>{try{this.use(JSON.parse(e))}catch(e){i?.use(new Error(`Failed to parse JSON: ${e}`))}})))}))},e.HashTable=function(e){return t.Message((function(){const i={};e.pipe(t.Tap((([e,t])=>{i[e]=t,this.use(i)})))}))},e.Loading=function(e,i){return t.Message((function(){e.pipe(t.Tap((()=>this.use(!0)))),i.pipe(t.Tap((()=>this.use(!1))))}))},e.Lock=function(e,i){return t.Message((function(){let s=!1;i.pipe(t.Tap((e=>{s=e})));t.Filtered(e,(()=>!s)).pipe(this)}))},e.Memo=function(e){return t.Message((function(){let i=null;e.pipe(t.Tap((e=>{e!==i&&t.isFilled(e)&&(this.use(e),i=e)})))}))},e.Not=function(e){return t.Message((function(){e.pipe(t.Tap((e=>{this.use(!e)})))}))},e.OnlyChanged=function(e){return t.Message((function(){let i=!1;e.pipe(t.Tap((e=>{!1===i?i=!0:this.use(e)})))}))},e.Or=function(e,i){return t.Message((function(){t.All(e,i).pipe(t.Tap((([e,t])=>{this.use(!(!e&&!t))})))}))},e.Part=function(e,i){return new p(e,t.ActualMessage(i))},e.Path=function(e,i){const s=t.ActualMessage(i);return t.Message((function(){t.All(e,s).pipe(t.Tap((([e,t])=>{const i=t.split(".");let s=e;i.forEach((e=>{s=s[e]})),void 0!==s&&s!==e&&this.use(s)})))}))},e.Polling=function(e,i){return t.Message((function(){i.pipe(t.Tap((()=>{e.pipe(this)})))}))},e.Record=a,e.RegexpMatch=function(e,i,s=t.Of("")){return t.Message((function(){t.All(e,i,s).pipe(t.Tap((([e,t,i])=>{const s=new RegExp(e,i).exec(t);this.use(s??[])})))}))},e.RegexpMatched=h,e.RegexpReplaced=function(e,i,s,n=t.Of("")){return t.Message((function(){t.All(i,e,s,n).pipe(t.Tap((([e,t,i,s])=>{this.use(String(t).replace(new RegExp(e,s),i))})))}))},e.Router=function(e,i,s){return t.Message((function(){const n=t.DestroyContainer(),r=()=>{n.destroy()};return t.All(i,e).pipe(t.Tap((([e,i])=>{r();t.All(...e.map((e=>h(t.Of(e.pattern),t.Of(i),e.patternFlags?t.Of(e.patternFlags):void 0)))).pipe(t.Tap((t=>{const i=t.findIndex((e=>!0===e));if(-1===i){const e=s.use();n.add(e),e.pipe(this)}if(i>-1){const t=e[i].message.use();n.add(t),t.pipe(this)}})))}))),r}))},e.Set=function(e,i,s){return t.Message((function(){t.All(e,i,s).pipe(t.Tap((([e,t,i])=>{e[t]=i,this.use(e)})))}))},e.Shot=function(e,i){return t.Message((function(){const s=t.Primitive(e);s.primitive(),i.pipe(t.Tap((()=>{const e=s.primitive();t.isFilled(e)&&this.use(e)})))}))},e.Task=function(e,i=0){return t.Message((function(){let s=null;t.ExecutorApplied(e,(e=>t=>{s&&clearTimeout(s),s=setTimeout((()=>{e(t)}),i)})).pipe(this)}))},e.Template=function(e=t.Of(""),i=t.Of({})){return new f(e,i)},e.Tick=function(e){return t.Message((function(){let i=!1,s=null;const n=()=>{i=!0,queueMicrotask((()=>{i=!1,null!==s&&(this.use(s),s=null)}))};e.pipe(t.Tap((e=>{s=e,i||n()})))}))},e.ToJson=function(e,i){return t.Message((function(){e.pipe(t.Tap((e=>{try{this.use(JSON.stringify(e))}catch{i?.use(new Error("Failed to convert to JSON"))}})))}))},e.Transaction=function(e,s,...n){return t.Message((function(){const r=t.LateShared(),u=[];return e.pipe(t.Tap((e=>{const o=s(t.Of(e),...n.map((e=>i(e))));u.push(o),o.pipe(r)}))),r.pipe(this),()=>{u.forEach((e=>e?.destroy())),u.length=0}}))}}({},silentium);
