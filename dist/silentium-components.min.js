var silentium=function(t,e){"use strict";function n(t,e,r){return null==e||Object.keys(e).forEach((i=>{const o=e[i],s=t[i],u=r(s,o,i,t,e);void 0!==u?t[i]=u:c(o)&&c(s)?n(s,o,r):t[i]=o})),t}function c(t){return null!=t&&"object"==typeof t}const r=Symbol("not-set");function i(t){return e.Message((function(n){const c=Object.keys(t);c.forEach((n=>{t[n]=e.Actual(t[n])})),e.All(...Object.values(t)).then((t=>{const e={};t.forEach(((t,n)=>{e[c[n]]=t})),n(e)}))}))}function o(t,n){const c=e.Actual(t);return e.Message((t=>{c.then((c=>{const r={},o=Object.fromEntries(Object.entries(c).map((t=>n[t[0]]?(r[t[0]]=1,[t[0],n[t[0]](c)]):[t[0],e.Of(t[1])])));Object.keys(n).forEach((t=>{r[t]||(o[t]=n[t](c))}));e.Once(i(o)).then(t)}))}))}function s(t,n,c=e.Of("")){const r=e.Actual(t),i=e.Actual(n),o=e.Actual(c);return e.Message((function(t){e.All(r,i,o).then((([e,n,c])=>{t(new RegExp(e,c).test(n))}))}))}var u=Object.defineProperty,a=(t,e,n)=>((t,e,n)=>e in t?u(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,"symbol"!=typeof e?e+"":e,n);class l{constructor(t=e.Of(""),n=e.Of({}),c=h){this.$src=t,this.$places=n,this.escapeFn=c,a(this,"dc",e.DestroyContainer()),a(this,"rejections",e.Rejections()),a(this,"vars",{$TPL:e.Of("$TPL")})}then(t){const n=i(this.vars);return e.Applied(e.All(this.$src,this.$places,n),(([t,e,n])=>{try{Object.entries(e).forEach((([e,n])=>{t=t.replaceAll(e,String(n))})),Object.entries(n).forEach((([e,n])=>{t=t.replaceAll(e,String(n))}))}catch(t){this.rejections.reject(t)}return t})).then(t),this}template(t){this.$src=e.Of(t)}raw(t){const n=`$var${Date.now().toString(36)+Math.random().toString(36).substring(2)}`;return e.isDestroyable(t)&&this.dc.add(t),this.vars[n]=t,n}escaped(t){return e.isDestroyable(t)&&this.dc.add(t),this.raw(e.Applied(t,this.escapeFn))}catch(t){return this.rejections.catch(t),this}destroy(){return this.dc.destroy(),this}}const f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};function h(t){return"string"!=typeof t&&(t=String(t)),t.replace(/[&<>"'/]/g,(t=>f[t]))}return t.And=function(t,n){return e.Message((function(c){e.All(t,n).then((([t,e])=>{c(!(!t||!e))}))}))},t.Bool=function(t){return e.Message((function(n){e.Applied(t,Boolean).then(n)}))},t.Branch=function(t,n,c){const r=e.Actual(t),i=e.Actual(n),o=e.Actual(c);return e.Message((function(t){const n=e.Primitive(i);let s;void 0!==c&&(s=e.Primitive(o)),r.then((e=>{if("boolean"!=typeof e)throw new Error("Branch received not boolean value");let c=null;!0===e?c=n.primitive():s&&(c=s.primitive()),null!==c&&t(c)}))}))},t.BranchLazy=function(t,n,c){return e.Message((function(r){const i=e.DestroyContainer(),o=()=>{i.destroy()};return t.then((t=>{let e;o(),t?e=n():c&&(e=c()),void 0!==e&&(e.then(r),i.add(e))})),o}))},t.Concatenated=function(t,n=e.Of("")){return e.Message((function(c){e.All(n,...t).then((([t,...e])=>{c(e.join(t))}))}))},t.Constant=function(t,n){return e.Message((function(c,r){n.catch(r).then((()=>{c(t),c(e.ResetSilenceCache)}))}))},t.Deadline=function(t,n){const c=e.Actual(n);return e.Message((function(n,r){let i=0;const o=e.Shared(t);c.then((t=>{i&&clearTimeout(i);let c=!1;i=setTimeout((()=>{c||(c=!0,r(new Error("Timeout reached in Deadline")))}),t);e.Filtered(o,(()=>!c)).then(n),o.then((()=>{c=!0}))}))}))},t.Deferred=function(t,n){return e.Message((function(c){const r=e.Primitive(t);n.then((()=>{const t=r.primitive();e.isFilled(t)&&c(t)}))}))},t.Detached=function(t){return e.Message((function(n){const c=e.Primitive(t).primitive();e.isFilled(c)&&n(c)}))},t.Dirty=function(t,n=[],c=[],r){const i=e.Late({});return void 0===r&&(r=t=>JSON.parse(JSON.stringify(t))),e.Source((function(o){const s=e.Applied(i,r);e.All(s,t).then((([t,e])=>{t&&o(Object.fromEntries(Object.entries(t).filter((([t,r])=>!!n.includes(t)||!c.includes(t)&&r!==e[t]))))}))}),(t=>{i.use(t)}))},t.First=function(t){return e.Message((function(n){e.Applied(t,(t=>t[0])).then(n)}))},t.FromJson=function(t){return e.Message((function(e,n){t.then((t=>{try{e(JSON.parse(t))}catch(t){n(new Error(`Failed to parse JSON: ${t}`))}}))}))},t.HashTable=function(t){return e.Message((function(e){const n={};t.then((([t,c])=>{n[t]=c,e({...n})}))}))},t.Loading=function(t,n){return e.Message((function(e){t.then((()=>e(!0))),n.then((()=>e(!1)))}))},t.Lock=function(t,n){return e.Message((function(c){let r=!1;n.then((t=>{r=t}));e.Filtered(t,(()=>!r)).then(c)}))},t.Memo=function(t){return e.Message((function(n){let c=null;t.then((t=>{t!==c&&e.isFilled(t)&&(n(t),c=t)}))}))},t.MergeAccumulation=function(t,c){const r=e.Late(),i={};return t.then((t=>{r.use(n(i,t,((t,e)=>{if(Array.isArray(t))return t.concat(e)})))})),c&&c.then((t=>{r.use(t)})),r},t.Not=function(t){return e.Message((function(e){t.then((t=>{e(!t)}))}))},t.OnlyChanged=function(t){return e.Message((function(e){let n=!1;t.then((t=>{!1===n?n=!0:e(t)}))}))},t.Or=function(t,n){return e.Message((function(c){e.All(t,n).then((([t,e])=>{c(!(!t&&!e))}))}))},t.Part=function(t,n,c){const r=e.Shared(t),i=e.Shared(e.Actual(n));return e.Source((function(t){e.All(r,i).then((([e,n])=>{const r=n.split(".");let i=e;r.forEach((t=>{i=i[t]})),void 0!==i&&i!==e?t(i):void 0!==c&&t(c)}))}),(n=>{const c=e.Primitive(i);if(e.isFilled(c)){const r=e.Primitive(t);t.use({...r.primitiveWithException(),[c.primitiveWithException()]:n})}}))},t.Path=function(t,n,c){const i=e.Actual(t),o=e.Actual(n),s=e.Actual(c??r);return e.Applied(e.All(i,o,s),(([t,e,n])=>{const c=e.split(".");let i=t;return c.forEach((t=>{i=i[t]})),void 0!==i&&i!==t?i:n!==r?n:void 0}))},t.Polling=function(t,n){return e.Message((function(c,r){const i=e.DestroyContainer();n.then((()=>{i.destroy(),c(e.ResetSilenceCache),i.add(t.then(c).catch(r))})).catch(r)}))},t.Record=i,t.RecordTruncated=function(t,n){const c=e.Actual(t),r=e.Actual(n),i=(t,e)=>{if(null===t||"object"!=typeof t||Array.isArray(t))return t;const n={};for(const[c,r]of Object.entries(t)){if(e.includes(r))continue;const t=i(r,e);void 0===t||"object"==typeof t&&null!==t&&!Array.isArray(t)&&0===Object.keys(t).length||(n[c]=t)}return n};return e.Computed(i,c,r)},t.RegexpMatch=function(t,n,c=e.Of("")){const r=e.Actual(t),i=e.Actual(n),o=e.Actual(c);return e.Message((function(t){e.All(r,i,o).then((([e,n,c])=>{const r=new RegExp(e,c).exec(n);t(r??[])}))}))},t.RegexpMatched=s,t.RegexpReplaced=function(t,n,c,r=""){const i=e.Actual(t),o=e.Actual(n),s=e.Actual(c),u=e.Actual(r);return e.Applied(e.All(o,i,s,u),(([t,e,n,c])=>String(e).replace(new RegExp(t,c),n)))},t.Router=function(t,n,c){const r=e.Actual(n),i=e.Actual(t);return e.Message((function(t){const n=e.DestroyContainer(),o=()=>{n.destroy()};return e.All(r,i).then((([r,i])=>{o();e.All(...r.map((t=>t.pattern?s(e.Of(t.pattern),e.Of(i),t.patternFlags?e.Of(t.patternFlags):void 0):t?.condition?.(i)))).then((i=>{const o=i.findIndex((t=>!0===t));if(-1===o){const r=e.Actual(c());n.add(r),r.then(t)}if(o>-1){const c=e.Actual(r[o].message());n.add(c),c.then(t)}}))})),o}))},t.Set=function(t,n,c){const r=e.Actual(t),i=e.Actual(n),o=e.Actual(c);return e.Message((function(t){e.All(r,i,o).then((([e,n,c])=>{e[n]=c,t(e)}))}))},t.StateRecord=function(t,n,c){const r=e.DestroyContainer();let i=-1,o=null,s={};const u=e.Value(e.Actual(c));return e.Message(((e,c)=>(r.add(t.then((t=>{t===u.value?.[i+1]?(i+=1,o=t):(i=-1,o=null,s={})})).catch(c)),r.add(n.then((t=>{null!==o&&(s[o]=t),i+1===u.value?.length&&(e(s),i=-1,o=null,s={})})).catch(c)),()=>r.destroy())))},t.Switch=function(t,n){const c=e.Actual(t);return e.Message(((t,r)=>{const i=e.DestroyContainer();return c.then((e=>{const c=n.find((t=>Array.isArray(t[0])?t[0].includes(e):t[0]===e));c&&i.add(c[1].then(t).catch(r))})).catch(r),i.destructor}))},t.Task=function(t,n=0){const c=e.Actual(t);return e.Message((function(t){let r=null;e.ExecutorApplied(c,(t=>e=>{r&&clearTimeout(r),r=setTimeout((()=>{t(e)}),n)})).then(t)}))},t.Template=function(t="",n=e.Of({})){const c=e.Late();("string"==typeof t||e.isMessage(t))&&c.chain(e.Actual(t));const r=new l(c,n?e.Actual(n):void 0);return"function"==typeof t&&c.chain(e.Message((e=>{e(t(r))}))),r},t.TemplateImpl=l,t.Tick=function(t){return e.Message((function(e){let n=!1,c=null;t.then((t=>{c=t,n||(n=!0,queueMicrotask((()=>{n=!1,null!==c&&(e(c),c=null)})))}))}))},t.ToJson=function(t){return e.Message((function(e,n){t.then((t=>{try{e(JSON.stringify(t))}catch{n(new Error("Failed to convert to JSON"))}}))}))},t.Transformed=o,t.TransformedList=function(t,n){return e.Map(e.Actual(t),(t=>o(t,n)))},t.escaped=h,t}({},silentium);
