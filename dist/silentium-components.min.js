var silentium=function(e,t){"use strict";function n(e,n,s){const i=t.ActualMessage(n),c=t.ActualMessage(s);return t.Message((function(n){t.All(e,i,c).then((([e,t,s])=>{const i=t.split(".");let c=e;i.forEach((e=>{c=c[e]})),void 0!==c&&c!==e?n(c):void 0!==s&&n(s)}))}))}function s(e,n,s=t.Of("")){const i=t.ActualMessage(e),c=t.ActualMessage(n),r=t.ActualMessage(s);return t.Message((function(e){t.All(i,c,r).then((([t,n,s])=>{e(new RegExp(t,s).test(n))}))}))}function i(e){return t.Message((function(n){const s=Object.keys(e);s.forEach((n=>{e[n]=t.ActualMessage(e[n])})),t.All(...Object.values(e)).then((e=>{const t={};e.forEach(((e,n)=>{t[s[n]]=e})),n(t)}))}))}var c=Object.defineProperty,r=(e,t,n)=>((e,t,n)=>t in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);class o{constructor(e=t.Of(""),n=t.Of({})){this.$src=e,this.$places=n,r(this,"dc",t.DestroyContainer()),r(this,"rejections",new t.Rejections),r(this,"vars",{$TPL:t.Of("$TPL")})}then(e){const n=i(this.vars);return t.Applied(t.All(this.$src,this.$places,n),(([e,t,n])=>{try{Object.entries(t).forEach((([t,n])=>{e=e.replaceAll(t,String(n))})),Object.entries(n).forEach((([t,n])=>{e=e.replaceAll(t,String(n))}))}catch(e){this.rejections.reject(e)}return e})).then(e),this}template(e){this.$src=t.Of(e)}var(e){const n=`$var${Object.keys(this.vars).length}`;return t.isDestroyable(e)&&this.dc.add(e),this.vars[n]=e,n}catch(e){return this.rejections.catch(e),this}destroy(){return this.dc.destroy(),this}}return e.And=function(e,n){return t.Message((function(s){t.All(e,n).then((([e,t])=>{s(!(!e||!t))}))}))},e.Bool=function(e){return t.Message((function(n){t.Applied(e,Boolean).then(n)}))},e.Branch=function(e,n,s){const i=t.ActualMessage(e),c=t.ActualMessage(n),r=s&&t.ActualMessage(s);return t.Message((function(e){const n=t.Primitive(c);let s;void 0!==r&&(s=t.Primitive(r)),i.then((t=>{let i=null;t?i=n.primitive():s&&(i=s.primitive()),null!==i&&e(i)}))}))},e.BranchLazy=function(e,n,s){return t.Message((function(i){const c=t.DestroyContainer(),r=()=>{c.destroy()};return e.then((e=>{let t;r(),e?t=n():s&&(t=s()),void 0!==t&&(t.then(i),c.add(t))})),r}))},e.Concatenated=function(e,n=t.Of("")){return t.Message((function(s){t.All(n,...e).then((([e,...t])=>{s(t.join(e))}))}))},e.Constant=function(e,n){return t.Message((function(t){n.then((()=>{t(e)}))}))},e.Deadline=function(e,n){const s=t.ActualMessage(n);return t.Message((function(n,i){let c=0;const r=t.Shared(e);s.then((e=>{c&&clearTimeout(c);let s=!1;c=setTimeout((()=>{s||(s=!0,i(new Error("Timeout reached in Deadline")))}),e);t.Filtered(r,(()=>!s)).then(n),r.then((()=>{s=!0}))}))}))},e.Deferred=function(e,n){return t.Message((function(s){const i=t.Primitive(e);n.then((()=>{const e=i.primitive();t.isFilled(e)&&s(e)}))}))},e.Detached=function(e){return t.Message((function(n){const s=t.Primitive(e).primitive();t.isFilled(s)&&n(s)}))},e.Dirty=function(e,n=[],s=[],i){const c=t.Late();return void 0===i&&(i=e=>JSON.parse(JSON.stringify(e))),t.MessageSource((function(r){const o=t.Applied(c,i);t.All(o,e).then((([e,t])=>{e&&r(Object.fromEntries(Object.entries(e).filter((([e,i])=>!!n.includes(e)||!s.includes(e)&&i!==t[e]))))}))}),(e=>{c.use(e)}))},e.First=function(e){return t.Message((function(n){t.Applied(e,(e=>e[0])).then(n)}))},e.FromJson=function(e){return t.Message((function(t,n){e.then((e=>{try{t(JSON.parse(e))}catch(e){n(new Error(`Failed to parse JSON: ${e}`))}}))}))},e.HashTable=function(e){return t.Message((function(t){const n={};e.then((([e,s])=>{n[e]=s,t(n)}))}))},e.Loading=function(e,n){return t.Message((function(t){e.then((()=>t(!0))),n.then((()=>t(!1)))}))},e.Lock=function(e,n){return t.Message((function(s){let i=!1;n.then((e=>{i=e}));t.Filtered(e,(()=>!i)).then(s)}))},e.Memo=function(e){return t.Message((function(n){let s=null;e.then((e=>{e!==s&&t.isFilled(e)&&(n(e),s=e)}))}))},e.Not=function(e){return t.Message((function(t){e.then((e=>{t(!e)}))}))},e.OnlyChanged=function(e){return t.Message((function(t){let n=!1;e.then((e=>{!1===n?n=!0:t(e)}))}))},e.Or=function(e,n){return t.Message((function(s){t.All(e,n).then((([e,t])=>{s(!(!e&&!t))}))}))},e.Part=function(e,n){const s=t.Shared(e),i=t.Shared(t.ActualMessage(n));return t.MessageSource((function(e){t.All(s,i).then((([t,n])=>{const s=n.split(".");let i=t;s.forEach((e=>{i=i[e]})),void 0!==i&&i!==t&&e(i)}))}),(n=>{const s=t.Primitive(i);if(t.isFilled(s)){const i=t.Primitive(e);e.use({...i.primitiveWithException(),[s.primitiveWithException()]:n})}}))},e.Path=n,e.PathExisted=function(e,s){const i=t.ActualMessage(e),c=t.ActualMessage(s);return t.Empty(n(i,c,t.Nothing))},e.Polling=function(e,n){return t.Message((function(t){n.then((()=>{e.then(t)}))}))},e.Record=i,e.RegexpMatch=function(e,n,s=t.Of("")){const i=t.ActualMessage(e),c=t.ActualMessage(n),r=t.ActualMessage(s);return t.Message((function(e){t.All(i,c,r).then((([t,n,s])=>{const i=new RegExp(t,s).exec(n);e(i??[])}))}))},e.RegexpMatched=s,e.RegexpReplaced=function(e,n,s,i=t.Of("")){return t.Message((function(c){t.All(n,e,s,i).then((([e,t,n,s])=>{c(String(t).replace(new RegExp(e,s),n))}))}))},e.Router=function(e,n,i){const c=t.ActualMessage(n);return t.Message((function(n){const r=t.DestroyContainer(),o=()=>{r.destroy()};return t.All(c,e).then((([e,c])=>{o();t.All(...e.map((e=>s(t.Of(e.pattern),t.Of(c),e.patternFlags?t.Of(e.patternFlags):void 0)))).then((t=>{const s=t.findIndex((e=>!0===e));if(-1===s){const e=i();r.add(e),e.then(n)}if(s>-1){const t=e[s].message();r.add(t),t.then(n)}}))})),o}))},e.Set=function(e,n,s){const i=t.ActualMessage(e),c=t.ActualMessage(n),r=t.ActualMessage(s);return t.Message((function(e){t.All(i,c,r).then((([t,n,s])=>{t[n]=s,e(t)}))}))},e.Shot=function(e,n){return t.Message((function(s){const i=t.Primitive(e);i.primitive(),n.then((()=>{const e=i.primitive();t.isFilled(e)&&s(e)}))}))},e.Task=function(e,n=0){const s=t.ActualMessage(e);return t.Message((function(e){let i=null;t.ExecutorApplied(s,(e=>t=>{i&&clearTimeout(i),i=setTimeout((()=>{e(t)}),n)})).then(e)}))},e.Template=function(e="",n=t.Of({})){const s=t.LateShared();("string"==typeof e||t.isMessage(e))&&s.chain(t.ActualMessage(e));const i=new o(s,n?t.ActualMessage(n):void 0);return"function"==typeof e&&s.chain(t.Message((t=>{t(e(i))}))),i},e.Tick=function(e){return t.Message((function(t){let n=!1,s=null;e.then((e=>{s=e,n||(n=!0,queueMicrotask((()=>{n=!1,null!==s&&(t(s),s=null)})))}))}))},e.ToJson=function(e){return t.Message((function(t,n){e.then((e=>{try{t(JSON.stringify(e))}catch{n(new Error("Failed to convert to JSON"))}}))}))},e}({},silentium);
