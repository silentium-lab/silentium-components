var silentium=function(e,t){"use strict";function n(e,t,r){return null==t||Object.keys(t).forEach((i=>{const c=t[i],o=e[i],a=r(o,c,i,e,t);void 0!==a?e[i]=a:s(c)&&s(o)?n(o,c,r):e[i]=c})),e}function s(e){return null!=e&&"object"==typeof e}const r=Symbol("not-set");function i(e,n,s){const i=t.ActualMessage(n),c=t.ActualMessage(s??r);return t.Applied(t.All(e,i,c),(([e,t,n])=>{const s=t.split(".");let i=e;return s.forEach((e=>{i=i[e]})),void 0!==i&&i!==e?i:n!==r?n:void 0}))}function c(e){return t.Message((function(n){const s=Object.keys(e);s.forEach((n=>{e[n]=t.ActualMessage(e[n])})),t.All(...Object.values(e)).then((e=>{const t={};e.forEach(((e,n)=>{t[s[n]]=e})),n(t)}))}))}function o(e,n){const s=t.ActualMessage(e);return t.Message((e=>{s.then((s=>{const r={},i=Object.fromEntries(Object.entries(s).map((e=>n[e[0]]?(r[e[0]]=1,[e[0],n[e[0]](s)]):[e[0],t.Of(e[1])])));Object.keys(n).forEach((e=>{r[e]||(i[e]=n[e](s))}));t.Once(c(i)).then(e)}))}))}function a(e,n,s=t.Of("")){const r=t.ActualMessage(e),i=t.ActualMessage(n),c=t.ActualMessage(s);return t.Message((function(e){t.All(r,i,c).then((([t,n,s])=>{e(new RegExp(t,s).test(n))}))}))}var u=Object.defineProperty,l=(e,t,n)=>((e,t,n)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);class f{constructor(e=t.Of(""),n=t.Of({}),s=g){this.$src=e,this.$places=n,this.escapeFn=s,l(this,"dc",t.DestroyContainer()),l(this,"rejections",new t.Rejections),l(this,"vars",{$TPL:t.Of("$TPL")})}then(e){const n=c(this.vars);return t.Applied(t.All(this.$src,this.$places,n),(([e,t,n])=>{try{Object.entries(t).forEach((([t,n])=>{e=e.replaceAll(t,String(n))})),Object.entries(n).forEach((([t,n])=>{e=e.replaceAll(t,String(n))}))}catch(e){this.rejections.reject(e)}return e})).then(e),this}template(e){this.$src=t.Of(e)}raw(e){const n=`$var${Date.now().toString(36)+Math.random().toString(36).substring(2)}`;return t.isDestroyable(e)&&this.dc.add(e),this.vars[n]=e,n}escaped(e){return t.isDestroyable(e)&&this.dc.add(e),this.raw(t.Applied(e,this.escapeFn))}catch(e){return this.rejections.catch(e),this}destroy(){return this.dc.destroy(),this}}const h={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};function g(e){return"string"!=typeof e&&(e=String(e)),e.replace(/[&<>"'/]/g,(e=>h[e]))}return e.And=function(e,n){return t.Message((function(s){t.All(e,n).then((([e,t])=>{s(!(!e||!t))}))}))},e.Bool=function(e){return t.Message((function(n){t.Applied(e,Boolean).then(n)}))},e.Branch=function(e,n,s){const r=t.ActualMessage(e),i=t.ActualMessage(n),c=t.ActualMessage(s);return t.Message((function(e){const n=t.Primitive(i);let o;void 0!==s&&(o=t.Primitive(c)),r.then((t=>{if("boolean"!=typeof t)throw new Error("Branch received not boolean value");let s=null;!0===t?s=n.primitive():o&&(s=o.primitive()),null!==s&&e(s)}))}))},e.BranchLazy=function(e,n,s){return t.Message((function(r){const i=t.DestroyContainer(),c=()=>{i.destroy()};return e.then((e=>{let t;c(),e?t=n():s&&(t=s()),void 0!==t&&(t.then(r),i.add(t))})),c}))},e.Concatenated=function(e,n=t.Of("")){return t.Message((function(s){t.All(n,...e).then((([e,...t])=>{s(t.join(e))}))}))},e.Constant=function(e,n){return t.Message((function(s,r){n.catch(r).then((()=>{s(e),s(t.ResetSilenceCache)}))}))},e.Deadline=function(e,n){const s=t.ActualMessage(n);return t.Message((function(n,r){let i=0;const c=t.Shared(e);s.then((e=>{i&&clearTimeout(i);let s=!1;i=setTimeout((()=>{s||(s=!0,r(new Error("Timeout reached in Deadline")))}),e);t.Filtered(c,(()=>!s)).then(n),c.then((()=>{s=!0}))}))}))},e.Deferred=function(e,n){return t.Message((function(s){const r=t.Primitive(e);n.then((()=>{const e=r.primitive();t.isFilled(e)&&s(e)}))}))},e.Detached=function(e){return t.Message((function(n){const s=t.Primitive(e).primitive();t.isFilled(s)&&n(s)}))},e.Dirty=function(e,n=[],s=[],r){const i=t.Late({});return void 0===r&&(r=e=>JSON.parse(JSON.stringify(e))),t.MessageSource((function(c){const o=t.Applied(i,r);t.All(o,e).then((([e,t])=>{e&&c(Object.fromEntries(Object.entries(e).filter((([e,r])=>!!n.includes(e)||!s.includes(e)&&r!==t[e]))))}))}),(e=>{i.use(e)}))},e.First=function(e){return t.Message((function(n){t.Applied(e,(e=>e[0])).then(n)}))},e.FromJson=function(e){return t.Message((function(t,n){e.then((e=>{try{t(JSON.parse(e))}catch(e){n(new Error(`Failed to parse JSON: ${e}`))}}))}))},e.HashTable=function(e){return t.Message((function(t){const n={};e.then((([e,s])=>{n[e]=s,t(n)}))}))},e.Loading=function(e,n){return t.Message((function(t){e.then((()=>t(!0))),n.then((()=>t(!1)))}))},e.Lock=function(e,n){return t.Message((function(s){let r=!1;n.then((e=>{r=e}));t.Filtered(e,(()=>!r)).then(s)}))},e.Memo=function(e){return t.Message((function(n){let s=null;e.then((e=>{e!==s&&t.isFilled(e)&&(n(e),s=e)}))}))},e.MergeAccumulation=function(e,s){const r=t.Late(),i={};return e.then((e=>{r.use(n(i,e,((e,t)=>{if(Array.isArray(e))return e.concat(t)})))})),s&&s.then((e=>{r.use(e)})),r},e.Not=function(e){return t.Message((function(t){e.then((e=>{t(!e)}))}))},e.OnlyChanged=function(e){return t.Message((function(t){let n=!1;e.then((e=>{!1===n?n=!0:t(e)}))}))},e.Or=function(e,n){return t.Message((function(s){t.All(e,n).then((([e,t])=>{s(!(!e&&!t))}))}))},e.Part=function(e,n,s){const r=t.Shared(e),i=t.Shared(t.ActualMessage(n));return t.MessageSource((function(e){t.All(r,i).then((([t,n])=>{const r=n.split(".");let i=t;r.forEach((e=>{i=i[e]})),void 0!==i&&i!==t?e(i):void 0!==s&&e(s)}))}),(n=>{const s=t.Primitive(i);if(t.isFilled(s)){const r=t.Primitive(e);e.use({...r.primitiveWithException(),[s.primitiveWithException()]:n})}}))},e.Path=i,e.PathExisted=function(e,n){const s=t.ActualMessage(e),r=t.ActualMessage(n);return t.Empty(i(s,r,t.Nothing))},e.Polling=function(e,n){return t.Message((function(t){n.then((()=>{e.then(t)}))}))},e.Record=c,e.RecordTruncated=function(e,n){const s=t.ActualMessage(e),r=t.ActualMessage(n),i=(e,t)=>{if(null===e||"object"!=typeof e||Array.isArray(e))return e;const n={};for(const[s,r]of Object.entries(e)){if(t.includes(r))continue;const e=i(r,t);void 0===e||"object"==typeof e&&null!==e&&!Array.isArray(e)&&0===Object.keys(e).length||(n[s]=e)}return n};return t.Computed(i,s,r)},e.RegexpMatch=function(e,n,s=t.Of("")){const r=t.ActualMessage(e),i=t.ActualMessage(n),c=t.ActualMessage(s);return t.Message((function(e){t.All(r,i,c).then((([t,n,s])=>{const r=new RegExp(t,s).exec(n);e(r??[])}))}))},e.RegexpMatched=a,e.RegexpReplaced=function(e,n,s,r=""){const i=t.ActualMessage(e),c=t.ActualMessage(n),o=t.ActualMessage(s),a=t.ActualMessage(r);return t.Applied(t.All(c,i,o,a),(([e,t,n,s])=>String(t).replace(new RegExp(e,s),n)))},e.Router=function(e,n,s){const r=t.ActualMessage(n);return t.Message((function(n){const i=t.DestroyContainer(),c=()=>{i.destroy()};return t.All(r,e).then((([e,r])=>{c();t.All(...e.map((e=>a(t.Of(e.pattern),t.Of(r),e.patternFlags?t.Of(e.patternFlags):void 0)))).then((t=>{const r=t.findIndex((e=>!0===e));if(-1===r){const e=s();i.add(e),e.then(n)}if(r>-1){const t=e[r].message();i.add(t),t.then(n)}}))})),c}))},e.Set=function(e,n,s){const r=t.ActualMessage(e),i=t.ActualMessage(n),c=t.ActualMessage(s);return t.Message((function(e){t.All(r,i,c).then((([t,n,s])=>{t[n]=s,e(t)}))}))},e.Shot=function(e,n){return t.Message((function(s){const r=t.Primitive(e);r.primitive(),n.then((()=>{const e=r.primitive();t.isFilled(e)&&s(e)}))}))},e.Task=function(e,n=0){const s=t.ActualMessage(e);return t.Message((function(e){let r=null;t.ExecutorApplied(s,(e=>t=>{r&&clearTimeout(r),r=setTimeout((()=>{e(t)}),n)})).then(e)}))},e.Template=function(e="",n=t.Of({})){const s=t.Late();("string"==typeof e||t.isMessage(e))&&s.chain(t.ActualMessage(e));const r=new f(s,n?t.ActualMessage(n):void 0);return"function"==typeof e&&s.chain(t.Message((t=>{t(e(r))}))),r},e.TemplateImpl=f,e.Tick=function(e){return t.Message((function(t){let n=!1,s=null;e.then((e=>{s=e,n||(n=!0,queueMicrotask((()=>{n=!1,null!==s&&(t(s),s=null)})))}))}))},e.ToJson=function(e){return t.Message((function(t,n){e.then((e=>{try{t(JSON.stringify(e))}catch{n(new Error("Failed to convert to JSON"))}}))}))},e.Transformed=o,e.TransformedList=function(e,n){return t.Map(t.ActualMessage(e),(e=>o(e,n)))},e.escaped=g,e}({},silentium);
