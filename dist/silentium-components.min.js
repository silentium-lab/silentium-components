!function(e,t){"use strict";function s(e){return t.Message((s=>{const r=t.Primitive(e).primitive();t.isFilled(r)&&s.use(r)}))}var r=Object.defineProperty,n=(e,t,s)=>((e,t,s)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class o{constructor(e,s=[],r=[],o){this.$base=e,this.keep=s,this.exclude=r,n(this,"$comparing",t.Late()),n(this,"cloner"),this.cloner=void 0===o?e=>JSON.parse(JSON.stringify(e)):o}to(e){const s=t.Applied(this.$comparing,this.cloner);return t.All(s,this.$base).to(t.Transport((([t,s])=>{t&&e.use(Object.fromEntries(Object.entries(t).filter((([e,t])=>!!this.keep.includes(e)||!this.exclude.includes(e)&&t!==s[e]))))}))),this}use(e){return this.$comparing.use(e),this}}var i=Object.defineProperty,a=(e,t,s)=>((e,t,s)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class u{constructor(e,s){a(this,"$base"),a(this,"$keyed"),this.$base=t.SharedSource(e),this.$keyed=t.Shared(s)}to(e){return t.All(this.$base,this.$keyed).to(t.Transport((([t,s])=>{const r=s.split(".");let n=t;r.forEach((e=>{n=n[e]})),void 0!==n&&n!==t&&e.use(n)}))),this}use(e){const s=t.Primitive(this.$keyed);if(t.isFilled(s)){const r=t.Primitive(this.$base);this.$base.use({...r.primitiveWithException(),[s.primitiveWithException()]:e})}return this}}function c(e){return t.Message((s=>{const r=Object.keys(e);r.forEach((s=>{t.isMessage(e[s])||(e[s]=t.Of(e[s]))})),t.All(...Object.values(e)).to(t.Transport((e=>{const t={};e.forEach(((e,s)=>{t[r[s]]=e})),s.use(t)})))}))}var l=Object.defineProperty,p=(e,t,s)=>((e,t,s)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);class f{constructor(e=t.Of(""),s=t.Of({})){this.$src=e,this.$places=s,p(this,"dc",t.DestroyContainer()),p(this,"vars",{$TPL:t.Of("$TPL")})}to(e){const s=c(this.vars);return t.Applied(t.All(this.$src,this.$places,s),(([e,t,s])=>(Object.entries(t).forEach((([t,s])=>{e=e.replaceAll(t,String(s))})),Object.entries(s).forEach((([t,s])=>{e=e.replaceAll(t,String(s))})),e))).to(e),this}template(e){this.$src=t.Of(e)}var(e){const s=`$var${Object.keys(this.vars).length}`;return t.isDestroyable(e)&&this.dc.add(e),this.vars[s]=e,s}destroy(){return this.dc.destroy(),this}}function h(e,s,r=t.Of("")){return t.Message((n=>{t.All(e,s,r).to(t.Transport((([e,t,s])=>{n.use(new RegExp(e,s).test(t))})))}))}e.And=function(e,s){return t.Message((r=>{t.All(e,s).to(t.Transport((([e,t])=>{r.use(e&&t)})))}))},e.Bool=function(e){return t.Message((s=>{t.Applied(e,Boolean).to(s)}))},e.Branch=function(e,s,r){const n=t.ActualMessage(e),o=t.ActualMessage(s),i=r&&t.ActualMessage(r);return t.Message((e=>{const s=t.Primitive(o);let r;void 0!==i&&(r=t.Primitive(i)),n.to(t.Transport((t=>{let n=null;t?n=s.primitive():r&&(n=r.primitive()),null!==n&&e.use(n)})))}))},e.BranchLazy=function(e,s,r){return t.Message((n=>{const o=t.DestroyContainer(),i=()=>{o.destroy()};return e.to(t.Transport((e=>{let t;i(),e?t=s.use():r&&(t=r.use()),void 0!==t&&(t.to(n),o.add(t))}))),i}))},e.Concatenated=function(e,s=t.Of("")){return t.Message((r=>{t.All(s,...e).to(t.Transport((([e,...t])=>{r.use(t.join(e))})))}))},e.Constant=function(e,s){return t.Message((r=>{s.to(t.Transport((()=>{r.use(e)})))}))},e.Deadline=function(e,s,r){const n=t.ActualMessage(r);return t.Message((r=>{let o=0;const i=t.Shared(s,!0);n.to(t.Transport((s=>{o&&clearTimeout(o);let n=!1;o=setTimeout((()=>{n||(n=!0,e.use(new Error("Timeout reached in Deadline")))}),s);t.Filtered(i,(()=>!n)).to(r),i.to(t.Transport((()=>{n=!0})))})))}))},e.Deferred=function(e,s){return t.Message((r=>{const n=t.Primitive(e);s.to(t.Transport((()=>{const e=n.primitive();t.isFilled(e)&&r.use(e)})))}))},e.Detached=s,e.Dirty=function(e,t=[],s=[],r){return new o(e,t,s,r)},e.First=function(e){return t.Message((s=>{t.Applied(e,(e=>e[0])).to(s)}))},e.FromJson=function(e,s){return t.Message((r=>{e.to(t.Transport((e=>{try{r.use(JSON.parse(e))}catch(e){s?.use(new Error(`Failed to parse JSON: ${e}`))}})))}))},e.HashTable=function(e){return t.Message((s=>{const r={};e.to(t.Transport((([e,t])=>{r[e]=t,s.use(r)})))}))},e.Loading=function(e,s){return t.Message((r=>{e.to(t.Transport((()=>r.use(!0)))),s.to(t.Transport((()=>r.use(!1))))}))},e.Lock=function(e,s){return t.Message((r=>{let n=!1;s.to(t.Transport((e=>{n=e})));t.Filtered(e,(()=>!n)).to(r)}))},e.Memo=function(e){return t.Message((s=>{let r=null;e.to(t.Transport((e=>{e!==r&&t.isFilled(e)&&(s.use(e),r=e)})))}))},e.Not=function(e){return t.Message((s=>{e.to(t.Transport((e=>{s.use(!e)})))}))},e.OnlyChanged=function(e){return t.Message((s=>{let r=!1;e.to(t.Transport((e=>{!1===r?r=!0:s.use(e)})))}))},e.Or=function(e,s){return t.Message((r=>{t.All(e,s).to(t.Transport((([e,t])=>{r.use(e||t)})))}))},e.Part=function(e,s){return new u(e,t.ActualMessage(s))},e.Path=function(e,s){const r=t.ActualMessage(s);return t.Message((s=>{t.All(e,r).to(t.Transport((([e,t])=>{const r=t.split(".");let n=e;r.forEach((e=>{n=n[e]})),void 0!==n&&n!==e&&s.use(n)})))}))},e.Polling=function(e,s){return t.Message((r=>{s.to(t.Transport((()=>{e.to(r)})))}))},e.Record=c,e.RegexpMatch=function(e,s,r=t.Of("")){return t.Message((n=>{t.All(e,s,r).to(t.Transport((([e,t,s])=>{const r=new RegExp(e,s).exec(t);n.use(r??[])})))}))},e.RegexpMatched=h,e.RegexpReplaced=function(e,s,r,n=t.Of("")){return t.Message((o=>{t.All(s,e,r,n).to(t.Transport((([e,t,s,r])=>{o.use(String(t).replace(new RegExp(e,r),s))})))}))},e.Router=function(e,s,r){return t.Message((n=>{const o=t.DestroyContainer(),i=()=>{o.destroy()};return t.All(s,e).to(t.Transport((([e,s])=>{i();t.All(...e.map((e=>h(t.Of(e.pattern),t.Of(s),e.patternFlags?t.Of(e.patternFlags):void 0)))).to(t.Transport((t=>{const s=t.findIndex((e=>!0===e));if(-1===s){const e=r.use();o.add(e),e.to(n)}if(s>-1){const t=e[s].message.use();o.add(t),t.to(n)}})))}))),i}))},e.Set=function(e,s,r){return t.Message((n=>{t.All(e,s,r).to(t.Transport((([e,t,s])=>{e[t]=s,n.use(e)})))}))},e.Shot=function(e,s){return t.Message((r=>{const n=t.Primitive(e);n.primitive(),s.to(t.Transport((()=>{const e=n.primitive();t.isFilled(e)&&r.use(e)})))}))},e.Task=function(e,s=0){return t.Message((r=>{let n=null;t.ExecutorApplied(e,(e=>t=>{n&&clearTimeout(n),n=setTimeout((()=>{e(t)}),s)})).to(r)}))},e.Template=function(e=t.Of(""),s=t.Of({})){return new f(e,s)},e.Tick=function(e){return t.Message((s=>{let r=!1,n=null;e.to(t.Transport((e=>{n=e,r||(r=!0,queueMicrotask((()=>{r=!1,null!==n&&(s.use(n),n=null)})))})))}))},e.ToJson=function(e,s){return t.Message((r=>{e.to(t.Transport((e=>{try{r.use(JSON.stringify(e))}catch{s?.use(new Error("Failed to convert to JSON"))}})))}))},e.Transaction=function(e,r,...n){return t.Message((o=>{const i=t.LateShared(),a=[];return e.to(t.Transport((e=>{const o=r(t.Of(e),...n.map((e=>s(e))));a.push(o),o.to(i)}))),i.to(o),()=>{a.forEach((e=>e?.destroy())),a.length=0}}))}}({},silentium);
