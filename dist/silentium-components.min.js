var silentium=function(t,e){"use strict";function n(t,e,c){return null==e||Object.keys(e).forEach((i=>{const o=e[i],s=t[i],u=c(s,o,i,t,e);void 0!==u?t[i]=u:r(o)&&r(s)?n(s,o,c):t[i]=o})),t}function r(t){return null!=t&&"object"==typeof t}const c=Symbol("not-set");function i(t){return e.Message((function(n){const r=Object.keys(t);r.forEach((n=>{t[n]=e.Actual(t[n])})),e.All(...Object.values(t)).then((t=>{const e={};t.forEach(((t,n)=>{e[r[n]]=t})),n(e)}))}))}function o(t,n){const r=e.Actual(t);return e.Message((t=>{r.then((r=>{const c={},o=Object.fromEntries(Object.entries(r).map((t=>n[t[0]]?(c[t[0]]=1,[t[0],n[t[0]](r)]):[t[0],e.Of(t[1])])));Object.keys(n).forEach((t=>{c[t]||(o[t]=n[t](r))}));e.Once(i(o)).then(t)}))}))}function s(t,n,r=e.Of("")){const c=e.Actual(t),i=e.Actual(n),o=e.Actual(r);return e.Message((function(t){e.All(c,i,o).then((([e,n,r])=>{t(new RegExp(e,r).test(n))}))}))}var u=Object.defineProperty,a=(t,e,n)=>((t,e,n)=>e in t?u(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,"symbol"!=typeof e?e+"":e,n);class l{constructor(t=e.Of(""),n=e.Of({}),r=h){this.$src=t,this.$places=n,this.escapeFn=r,a(this,"dc",e.DestroyContainer()),a(this,"rejections",e.Rejections()),a(this,"vars",{$TPL:e.Of("$TPL")})}then(t){const n=i(this.vars);return e.Applied(e.All(this.$src,this.$places,n),(([t,e,n])=>{try{Object.entries(e).forEach((([e,n])=>{t=t.replaceAll(e,String(n))})),Object.entries(n).forEach((([e,n])=>{t=t.replaceAll(e,String(n))}))}catch(t){this.rejections.reject(t)}return t})).then(t),this}template(t){this.$src=e.Of(t)}raw(t){const n=`$var${Date.now().toString(36)+Math.random().toString(36).substring(2)}`;return e.isDestroyable(t)&&this.dc.add(t),this.vars[n]=t,n}escaped(t){return e.isDestroyable(t)&&this.dc.add(t),this.raw(e.Applied(t,this.escapeFn))}catch(t){return this.rejections.catch(t),this}destroy(){return this.dc.destroy(),this}}const f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};function h(t){return"string"!=typeof t&&(t=String(t)),t.replace(/[&<>"'/]/g,(t=>f[t]))}return t.And=function(t,n){return e.Message((function(r){e.All(t,n).then((([t,e])=>{r(!(!t||!e))}))}))},t.Bool=function(t){return e.Message((function(n){e.Applied(t,Boolean).then(n)}))},t.Branch=function(t,n,r){const c=e.Actual(t),i=e.Actual(n),o=e.Actual(r);return e.Message((function(t){const n=e.Primitive(i);let s;void 0!==r&&(s=e.Primitive(o)),c.then((e=>{if("boolean"!=typeof e)throw new Error("Branch received not boolean value");let r=null;!0===e?r=n.primitive():s&&(r=s.primitive()),null!==r&&t(r)}))}))},t.BranchLazy=function(t,n,r){return e.Message((function(c){const i=e.DestroyContainer(),o=()=>{i.destroy()};return t.then((t=>{let e;o(),t?e=n():r&&(e=r()),void 0!==e&&(e.then(c),i.add(e))})),o}))},t.Concatenated=function(t,n=e.Of("")){return e.Message((function(r){e.All(n,...t).then((([t,...e])=>{r(e.join(t))}))}))},t.Constant=function(t,n){return e.Message((function(r,c){n.catch(c).then((()=>{r(t),r(e.ResetSilenceCache)}))}))},t.Deadline=function(t,n){const r=e.Actual(n);return e.Message((function(n,c){let i=0;const o=e.Shared(t);r.then((t=>{i&&clearTimeout(i);let r=!1;i=setTimeout((()=>{r||(r=!0,c(new Error("Timeout reached in Deadline")))}),t);e.Filtered(o,(()=>!r)).then(n),o.then((()=>{r=!0}))}))}))},t.Deferred=function(t,n){return e.Message((function(r){const c=e.Primitive(t);n.then((()=>{const t=c.primitive();e.isFilled(t)&&r(t)}))}))},t.Detached=function(t){return e.Message((function(n){const r=e.Primitive(t).primitive();e.isFilled(r)&&n(r)}))},t.Dirty=function(t,n=[],r=[],c){const i=e.Late({});return void 0===c&&(c=t=>JSON.parse(JSON.stringify(t))),e.Source((function(o){const s=e.Applied(i,c);e.All(s,t).then((([t,e])=>{t&&o(Object.fromEntries(Object.entries(t).filter((([t,c])=>!!n.includes(t)||!r.includes(t)&&c!==e[t]))))}))}),(t=>{i.use(t)}))},t.First=function(t){return e.Message((function(n){e.Applied(t,(t=>t[0])).then(n)}))},t.FromJson=function(t){return e.Message((function(e,n){t.then((t=>{try{e(JSON.parse(t))}catch(t){n(new Error(`Failed to parse JSON: ${t}`))}}))}))},t.HashTable=function(t){return e.Message((function(e){const n={};t.then((([t,r])=>{n[t]=r,e(n)}))}))},t.Loading=function(t,n){return e.Message((function(e){t.then((()=>e(!0))),n.then((()=>e(!1)))}))},t.Lock=function(t,n){return e.Message((function(r){let c=!1;n.then((t=>{c=t}));e.Filtered(t,(()=>!c)).then(r)}))},t.Memo=function(t){return e.Message((function(n){let r=null;t.then((t=>{t!==r&&e.isFilled(t)&&(n(t),r=t)}))}))},t.MergeAccumulation=function(t,r){const c=e.Late(),i={};return t.then((t=>{c.use(n(i,t,((t,e)=>{if(Array.isArray(t))return t.concat(e)})))})),r&&r.then((t=>{c.use(t)})),c},t.Not=function(t){return e.Message((function(e){t.then((t=>{e(!t)}))}))},t.OnlyChanged=function(t){return e.Message((function(e){let n=!1;t.then((t=>{!1===n?n=!0:e(t)}))}))},t.Or=function(t,n){return e.Message((function(r){e.All(t,n).then((([t,e])=>{r(!(!t&&!e))}))}))},t.Part=function(t,n,r){const c=e.Shared(t),i=e.Shared(e.Actual(n));return e.Source((function(t){e.All(c,i).then((([e,n])=>{const c=n.split(".");let i=e;c.forEach((t=>{i=i[t]})),void 0!==i&&i!==e?t(i):void 0!==r&&t(r)}))}),(n=>{const r=e.Primitive(i);if(e.isFilled(r)){const c=e.Primitive(t);t.use({...c.primitiveWithException(),[r.primitiveWithException()]:n})}}))},t.Path=function(t,n,r){const i=e.Actual(t),o=e.Actual(n),s=e.Actual(r??c);return e.Applied(e.All(i,o,s),(([t,e,n])=>{const r=e.split(".");let i=t;return r.forEach((t=>{i=i[t]})),void 0!==i&&i!==t?i:n!==c?n:void 0}))},t.Polling=function(t,n){return e.Message((function(r,c){const i=e.DestroyContainer();n.then((()=>{i.destroy(),r(e.ResetSilenceCache),i.add(t.then(r).catch(c))})).catch(c)}))},t.Record=i,t.RecordTruncated=function(t,n){const r=e.Actual(t),c=e.Actual(n),i=(t,e)=>{if(null===t||"object"!=typeof t||Array.isArray(t))return t;const n={};for(const[r,c]of Object.entries(t)){if(e.includes(c))continue;const t=i(c,e);void 0===t||"object"==typeof t&&null!==t&&!Array.isArray(t)&&0===Object.keys(t).length||(n[r]=t)}return n};return e.Computed(i,r,c)},t.RegexpMatch=function(t,n,r=e.Of("")){const c=e.Actual(t),i=e.Actual(n),o=e.Actual(r);return e.Message((function(t){e.All(c,i,o).then((([e,n,r])=>{const c=new RegExp(e,r).exec(n);t(c??[])}))}))},t.RegexpMatched=s,t.RegexpReplaced=function(t,n,r,c=""){const i=e.Actual(t),o=e.Actual(n),s=e.Actual(r),u=e.Actual(c);return e.Applied(e.All(o,i,s,u),(([t,e,n,r])=>String(e).replace(new RegExp(t,r),n)))},t.Router=function(t,n,r){const c=e.Actual(n),i=e.Actual(t);return e.Message((function(t){const n=e.DestroyContainer(),o=()=>{n.destroy()};return e.All(c,i).then((([c,i])=>{o();e.All(...c.map((t=>t.pattern?s(e.Of(t.pattern),e.Of(i),t.patternFlags?e.Of(t.patternFlags):void 0):t?.condition?.(i)))).then((i=>{const o=i.findIndex((t=>!0===t));if(-1===o){const c=e.Actual(r());n.add(c),c.then(t)}if(o>-1){const r=e.Actual(c[o].message());n.add(r),r.then(t)}}))})),o}))},t.Set=function(t,n,r){const c=e.Actual(t),i=e.Actual(n),o=e.Actual(r);return e.Message((function(t){e.All(c,i,o).then((([e,n,r])=>{e[n]=r,t(e)}))}))},t.Switch=function(t,n){const r=e.Actual(t);return e.Message(((t,c)=>{const i=e.DestroyContainer();return r.then((e=>{const r=n.find((t=>Array.isArray(t[0])?t[0].includes(e):t[0]===e));r&&i.add(r[1].then(t).catch(c))})).catch(c),i.destructor}))},t.Task=function(t,n=0){const r=e.Actual(t);return e.Message((function(t){let c=null;e.ExecutorApplied(r,(t=>e=>{c&&clearTimeout(c),c=setTimeout((()=>{t(e)}),n)})).then(t)}))},t.Template=function(t="",n=e.Of({})){const r=e.Late();("string"==typeof t||e.isMessage(t))&&r.chain(e.Actual(t));const c=new l(r,n?e.Actual(n):void 0);return"function"==typeof t&&r.chain(e.Message((e=>{e(t(c))}))),c},t.TemplateImpl=l,t.Tick=function(t){return e.Message((function(e){let n=!1,r=null;t.then((t=>{r=t,n||(n=!0,queueMicrotask((()=>{n=!1,null!==r&&(e(r),r=null)})))}))}))},t.ToJson=function(t){return e.Message((function(e,n){t.then((t=>{try{e(JSON.stringify(t))}catch{n(new Error("Failed to convert to JSON"))}}))}))},t.Transformed=o,t.TransformedList=function(t,n){return e.Map(e.Actual(t),(t=>o(t,n)))},t.escaped=h,t}({},silentium);
