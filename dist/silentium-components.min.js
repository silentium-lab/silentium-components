!function(e,t){"use strict";function r(e){return t.Message((r=>{const s=t.Primitive(e).primitive();t.isFilled(s)&&r.use(s)}))}var s=Object.defineProperty,n=(e,t,r)=>((e,t,r)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r)(e,"symbol"!=typeof t?t+"":t,r);class o{constructor(e,r=[],s=[],o){this.$base=e,this.keep=r,this.exclude=s,n(this,"$comparing",t.Late()),n(this,"cloner"),this.cloner=void 0===o?e=>JSON.parse(JSON.stringify(e)):o}to(e){const r=t.Applied(this.$comparing,this.cloner);return t.All(r,this.$base).to(t.Transport((([t,r])=>{t&&e.use(Object.fromEntries(Object.entries(t).filter((([e,t])=>!!this.keep.includes(e)||!this.exclude.includes(e)&&t!==r[e]))))}))),this}use(e){return this.$comparing.use(e),this}}var i=Object.defineProperty,a=(e,t,r)=>((e,t,r)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r)(e,"symbol"!=typeof t?t+"":t,r);class u{constructor(e,r){a(this,"$base"),a(this,"$keyed"),this.$base=t.SharedSource(e),this.$keyed=t.Shared(r)}to(e){return t.All(this.$base,this.$keyed).to(t.Transport((([t,r])=>{const s=r.split(".");let n=t;s.forEach((e=>{n=n[e]})),void 0!==n&&n!==t&&e.use(n)}))),this}use(e){const r=t.Primitive(this.$keyed);if(t.isFilled(r)){const s=t.Primitive(this.$base);this.$base.use({...s.primitiveWithException(),[r.primitiveWithException()]:e})}return this}}function c(e){return t.Message((r=>{const s=Object.keys(e);s.forEach((r=>{t.isMessage(e[r])||(e[r]=t.Of(e[r]))})),t.All(...Object.values(e)).to(t.Transport((e=>{const t={};e.forEach(((e,r)=>{t[s[r]]=e})),r.use(t)})))}))}var l=Object.defineProperty,p=(e,t,r)=>((e,t,r)=>t in e?l(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r)(e,"symbol"!=typeof t?t+"":t,r);class f{constructor(e=t.Of(""),r=t.Of({})){this.$src=e,this.$places=r,p(this,"dc",t.DestroyContainer()),p(this,"vars",{$TPL:t.Of("$TPL")})}to(e){const r=c(this.vars);return t.Applied(t.All(this.$src,this.$places,r),(([e,t,r])=>(Object.entries(t).forEach((([t,r])=>{e=e.replaceAll(t,String(r))})),Object.entries(r).forEach((([t,r])=>{e=e.replaceAll(t,String(r))})),e))).to(e),this}template(e){this.$src=t.Of(e)}var(e){const r=`$var${Object.keys(this.vars).length}`;return t.isDestroyable(e)&&this.dc.add(e),this.vars[r]=e,r}destroy(){return this.dc.destroy(),this}}function h(e,r,s=t.Of("")){return t.Message((n=>{t.All(e,r,s).to(t.Transport((([e,t,r])=>{n.use(new RegExp(e,r).test(t))})))}))}e.And=function(e,r){return t.Message((s=>{t.All(e,r).to(t.Transport((([e,t])=>{s.use(e&&t)})))}))},e.Bool=function(e){return t.Message((r=>{t.Applied(e,Boolean).to(r)}))},e.Branch=function(e,r,s){return t.Message((n=>{const o=t.Primitive(r);let i;void 0!==s&&(i=t.Primitive(s)),e.to(t.Transport((e=>{let t=null;e?t=o.primitive():i&&(t=i.primitive()),null!==t&&n.use(t)})))}))},e.BranchLazy=function(e,r,s){return t.Message((n=>{const o=t.DestroyContainer(),i=()=>{o.destroy()};return e.to(t.Transport((e=>{let t;i(),e?t=r.use():s&&(t=s.use()),void 0!==t&&(t.to(n),o.add(t))}))),i}))},e.Concatenated=function(e,r=t.Of("")){return t.Message((s=>{t.All(r,...e).to(t.Transport((([e,...t])=>{s.use(t.join(e))})))}))},e.Constant=function(e,r){return t.Message((s=>{r.to(t.Transport((()=>{s.use(e)})))}))},e.Deadline=function(e,r,s){return t.Message((n=>{let o=0;const i=t.Shared(r,!0);s.to(t.Transport((r=>{o&&clearTimeout(o);let s=!1;o=setTimeout((()=>{s||(s=!0,e.use(new Error("Timeout reached in Deadline")))}),r);t.Filtered(i,(()=>!s)).to(n),i.to(t.Transport((()=>{s=!0})))})))}))},e.Deferred=function(e,r){return t.Message((s=>{const n=t.Primitive(e);r.to(t.Transport((()=>{const e=n.primitive();t.isFilled(e)&&s.use(e)})))}))},e.Detached=r,e.Dirty=function(e,t=[],r=[],s){return new o(e,t,r,s)},e.First=function(e){return t.Message((r=>{t.Applied(e,(e=>e[0])).to(r)}))},e.FromJson=function(e,r){return t.Message((s=>{e.to(t.Transport((e=>{try{s.use(JSON.parse(e))}catch(e){r?.use(new Error(`Failed to parse JSON: ${e}`))}})))}))},e.HashTable=function(e){return t.Message((r=>{const s={};e.to(t.Transport((([e,t])=>{s[e]=t,r.use(s)})))}))},e.Loading=function(e,r){return t.Message((s=>{e.to(t.Transport((()=>s.use(!0)))),r.to(t.Transport((()=>s.use(!1))))}))},e.Lock=function(e,r){return t.Message((s=>{let n=!1;r.to(t.Transport((e=>{n=e})));t.Filtered(e,(()=>!n)).to(s)}))},e.Memo=function(e){return t.Message((r=>{let s=null;e.to(t.Transport((e=>{e!==s&&t.isFilled(e)&&(r.use(e),s=e)})))}))},e.Not=function(e){return t.Message((r=>{e.to(t.Transport((e=>{r.use(!e)})))}))},e.OnlyChanged=function(e){return t.Message((r=>{let s=!1;e.to(t.Transport((e=>{!1===s?s=!0:r.use(e)})))}))},e.Or=function(e,r){return t.Message((s=>{t.All(e,r).to(t.Transport((([e,t])=>{s.use(e||t)})))}))},e.Part=function(e,t){return new u(e,t)},e.Path=function(e,r){return t.Message((s=>{t.All(e,r).to(t.Transport((([e,t])=>{const r=t.split(".");let n=e;r.forEach((e=>{n=n[e]})),void 0!==n&&n!==e&&s.use(n)})))}))},e.Polling=function(e,r){return t.Message((s=>{r.to(t.Transport((()=>{e.to(s)})))}))},e.Record=c,e.RegexpMatch=function(e,r,s=t.Of("")){return t.Message((n=>{t.All(e,r,s).to(t.Transport((([e,t,r])=>{const s=new RegExp(e,r).exec(t);n.use(s??[])})))}))},e.RegexpMatched=h,e.RegexpReplaced=function(e,r,s,n=t.Of("")){return t.Message((o=>{t.All(r,e,s,n).to(t.Transport((([e,t,r,s])=>{o.use(String(t).replace(new RegExp(e,s),r))})))}))},e.Router=function(e,r,s){return t.Message((n=>{const o=t.DestroyContainer(),i=()=>{o.destroy()};return t.All(r,e).to(t.Transport((([e,r])=>{i();t.All(...e.map((e=>h(t.Of(e.pattern),t.Of(r),e.patternFlags?t.Of(e.patternFlags):void 0)))).to(t.Transport((t=>{const r=t.findIndex((e=>!0===e));if(-1===r){const e=s.use();o.add(e),e.to(n)}if(r>-1){const t=e[r].message.use();o.add(t),t.to(n)}})))}))),i}))},e.Set=function(e,r,s){return t.Message((n=>{t.All(e,r,s).to(t.Transport((([e,t,r])=>{e[t]=r,n.use(e)})))}))},e.Shot=function(e,r){return t.Message((s=>{const n=t.Primitive(e);n.primitive(),r.to(t.Transport((()=>{const e=n.primitive();t.isFilled(e)&&s.use(e)})))}))},e.Task=function(e,r=0){return t.Message((s=>{let n=null;t.ExecutorApplied(e,(e=>t=>{n&&clearTimeout(n),n=setTimeout((()=>{e(t)}),r)})).to(s)}))},e.Template=function(e=t.Of(""),r=t.Of({})){return new f(e,r)},e.Tick=function(e){return t.Message((r=>{let s=!1,n=null;e.to(t.Transport((e=>{n=e,s||(s=!0,queueMicrotask((()=>{s=!1,null!==n&&(r.use(n),n=null)})))})))}))},e.ToJson=function(e,r){return t.Message((s=>{e.to(t.Transport((e=>{try{s.use(JSON.stringify(e))}catch{r?.use(new Error("Failed to convert to JSON"))}})))}))},e.Transaction=function(e,s,...n){return t.Message((o=>{const i=t.LateShared(),a=[];return e.to(t.Transport((e=>{const o=s(t.Of(e),...n.map((e=>r(e))));a.push(o),o.to(i)}))),i.to(o),()=>{a.forEach((e=>e?.destroy())),a.length=0}}))}}({},silentium);
