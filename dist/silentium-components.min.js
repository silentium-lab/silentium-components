var silentium=function(t,e){"use strict";function n(t,e,i){return null==e||Object.keys(e).forEach((c=>{const o=e[c],s=t[c],u=i(s,o,c,t,e);void 0!==u?t[c]=u:r(o)&&r(s)?n(s,o,i):t[c]=o})),t}function r(t){return null!=t&&"object"==typeof t}const i=Symbol("not-set");function c(t){return e.Message((function(n){const r=Object.keys(t);r.forEach((n=>{t[n]=e.Actual(t[n])})),e.All(...Object.values(t)).then((t=>{const e={};t.forEach(((t,n)=>{e[r[n]]=t})),n(e)}))}))}function o(t,n){const r=e.Actual(t);return e.Message((t=>{r.then((r=>{const i={},o=Object.fromEntries(Object.entries(r).map((t=>n[t[0]]?(i[t[0]]=1,[t[0],n[t[0]](r)]):[t[0],e.Of(t[1])])));Object.keys(n).forEach((t=>{i[t]||(o[t]=n[t](r))}));e.Once(c(o)).then(t)}))}))}function s(t,n,r=e.Of("")){const i=e.Actual(t),c=e.Actual(n),o=e.Actual(r);return e.Message((function(t){e.All(i,c,o).then((([e,n,r])=>{t(new RegExp(e,r).test(n))}))}))}var u=Object.defineProperty,a=(t,e,n)=>((t,e,n)=>e in t?u(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n)(t,"symbol"!=typeof e?e+"":e,n);class l{constructor(t=e.Of(""),n=e.Of({}),r=h){this.$src=t,this.$places=n,this.escapeFn=r,a(this,"dc",e.DestroyContainer()),a(this,"rejections",new e.Rejections),a(this,"vars",{$TPL:e.Of("$TPL")})}then(t){const n=c(this.vars);return e.Applied(e.All(this.$src,this.$places,n),(([t,e,n])=>{try{Object.entries(e).forEach((([e,n])=>{t=t.replaceAll(e,String(n))})),Object.entries(n).forEach((([e,n])=>{t=t.replaceAll(e,String(n))}))}catch(t){this.rejections.reject(t)}return t})).then(t),this}template(t){this.$src=e.Of(t)}raw(t){const n=`$var${Date.now().toString(36)+Math.random().toString(36).substring(2)}`;return e.isDestroyable(t)&&this.dc.add(t),this.vars[n]=t,n}escaped(t){return e.isDestroyable(t)&&this.dc.add(t),this.raw(e.Applied(t,this.escapeFn))}catch(t){return this.rejections.catch(t),this}destroy(){return this.dc.destroy(),this}}const f={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};function h(t){return"string"!=typeof t&&(t=String(t)),t.replace(/[&<>"'/]/g,(t=>f[t]))}return t.And=function(t,n){return e.Message((function(r){e.All(t,n).then((([t,e])=>{r(!(!t||!e))}))}))},t.Bool=function(t){return e.Message((function(n){e.Applied(t,Boolean).then(n)}))},t.Branch=function(t,n,r){const i=e.Actual(t),c=e.Actual(n),o=e.Actual(r);return e.Message((function(t){const n=e.Primitive(c);let s;void 0!==r&&(s=e.Primitive(o)),i.then((e=>{if("boolean"!=typeof e)throw new Error("Branch received not boolean value");let r=null;!0===e?r=n.primitive():s&&(r=s.primitive()),null!==r&&t(r)}))}))},t.BranchLazy=function(t,n,r){return e.Message((function(i){const c=e.DestroyContainer(),o=()=>{c.destroy()};return t.then((t=>{let e;o(),t?e=n():r&&(e=r()),void 0!==e&&(e.then(i),c.add(e))})),o}))},t.Concatenated=function(t,n=e.Of("")){return e.Message((function(r){e.All(n,...t).then((([t,...e])=>{r(e.join(t))}))}))},t.Constant=function(t,n){return e.Message((function(r,i){n.catch(i).then((()=>{r(t),r(e.ResetSilenceCache)}))}))},t.Deadline=function(t,n){const r=e.Actual(n);return e.Message((function(n,i){let c=0;const o=e.Shared(t);r.then((t=>{c&&clearTimeout(c);let r=!1;c=setTimeout((()=>{r||(r=!0,i(new Error("Timeout reached in Deadline")))}),t);e.Filtered(o,(()=>!r)).then(n),o.then((()=>{r=!0}))}))}))},t.Deferred=function(t,n){return e.Message((function(r){const i=e.Primitive(t);n.then((()=>{const t=i.primitive();e.isFilled(t)&&r(t)}))}))},t.Detached=function(t){return e.Message((function(n){const r=e.Primitive(t).primitive();e.isFilled(r)&&n(r)}))},t.Dirty=function(t,n=[],r=[],i){const c=e.Late({});return void 0===i&&(i=t=>JSON.parse(JSON.stringify(t))),e.Source((function(o){const s=e.Applied(c,i);e.All(s,t).then((([t,e])=>{t&&o(Object.fromEntries(Object.entries(t).filter((([t,i])=>!!n.includes(t)||!r.includes(t)&&i!==e[t]))))}))}),(t=>{c.use(t)}))},t.First=function(t){return e.Message((function(n){e.Applied(t,(t=>t[0])).then(n)}))},t.FromJson=function(t){return e.Message((function(e,n){t.then((t=>{try{e(JSON.parse(t))}catch(t){n(new Error(`Failed to parse JSON: ${t}`))}}))}))},t.HashTable=function(t){return e.Message((function(e){const n={};t.then((([t,r])=>{n[t]=r,e(n)}))}))},t.Loading=function(t,n){return e.Message((function(e){t.then((()=>e(!0))),n.then((()=>e(!1)))}))},t.Lock=function(t,n){return e.Message((function(r){let i=!1;n.then((t=>{i=t}));e.Filtered(t,(()=>!i)).then(r)}))},t.Memo=function(t){return e.Message((function(n){let r=null;t.then((t=>{t!==r&&e.isFilled(t)&&(n(t),r=t)}))}))},t.MergeAccumulation=function(t,r){const i=e.Late(),c={};return t.then((t=>{i.use(n(c,t,((t,e)=>{if(Array.isArray(t))return t.concat(e)})))})),r&&r.then((t=>{i.use(t)})),i},t.Not=function(t){return e.Message((function(e){t.then((t=>{e(!t)}))}))},t.OnlyChanged=function(t){return e.Message((function(e){let n=!1;t.then((t=>{!1===n?n=!0:e(t)}))}))},t.Or=function(t,n){return e.Message((function(r){e.All(t,n).then((([t,e])=>{r(!(!t&&!e))}))}))},t.Part=function(t,n,r){const i=e.Shared(t),c=e.Shared(e.Actual(n));return e.Source((function(t){e.All(i,c).then((([e,n])=>{const i=n.split(".");let c=e;i.forEach((t=>{c=c[t]})),void 0!==c&&c!==e?t(c):void 0!==r&&t(r)}))}),(n=>{const r=e.Primitive(c);if(e.isFilled(r)){const i=e.Primitive(t);t.use({...i.primitiveWithException(),[r.primitiveWithException()]:n})}}))},t.Path=function(t,n,r){const c=e.Actual(t),o=e.Actual(n),s=e.Actual(r??i);return e.Empty(e.Applied(e.All(c,o,s),(([t,e,n])=>{const r=e.split(".");let c=t;return r.forEach((t=>{c=c[t]})),void 0!==c&&c!==t?c:n!==i?n:void 0})))},t.Polling=function(t,n){return e.Message((function(e){n.then((()=>{t.then(e)}))}))},t.Record=c,t.RecordTruncated=function(t,n){const r=e.Actual(t),i=e.Actual(n),c=(t,e)=>{if(null===t||"object"!=typeof t||Array.isArray(t))return t;const n={};for(const[r,i]of Object.entries(t)){if(e.includes(i))continue;const t=c(i,e);void 0===t||"object"==typeof t&&null!==t&&!Array.isArray(t)&&0===Object.keys(t).length||(n[r]=t)}return n};return e.Computed(c,r,i)},t.RegexpMatch=function(t,n,r=e.Of("")){const i=e.Actual(t),c=e.Actual(n),o=e.Actual(r);return e.Message((function(t){e.All(i,c,o).then((([e,n,r])=>{const i=new RegExp(e,r).exec(n);t(i??[])}))}))},t.RegexpMatched=s,t.RegexpReplaced=function(t,n,r,i=""){const c=e.Actual(t),o=e.Actual(n),s=e.Actual(r),u=e.Actual(i);return e.Applied(e.All(o,c,s,u),(([t,e,n,r])=>String(e).replace(new RegExp(t,r),n)))},t.Router=function(t,n,r){const i=e.Actual(n);return e.Message((function(n){const c=e.DestroyContainer(),o=()=>{c.destroy()};return e.All(i,t).then((([t,i])=>{o();e.All(...t.map((t=>s(e.Of(t.pattern),e.Of(i),t.patternFlags?e.Of(t.patternFlags):void 0)))).then((e=>{const i=e.findIndex((t=>!0===t));if(-1===i){const t=r();c.add(t),t.then(n)}if(i>-1){const e=t[i].message();c.add(e),e.then(n)}}))})),o}))},t.Set=function(t,n,r){const i=e.Actual(t),c=e.Actual(n),o=e.Actual(r);return e.Message((function(t){e.All(i,c,o).then((([e,n,r])=>{e[n]=r,t(e)}))}))},t.Shot=function(t,n){return e.Message((function(r){const i=e.Primitive(t);i.primitive(),n.then((()=>{const t=i.primitive();e.isFilled(t)&&r(t)}))}))},t.Task=function(t,n=0){const r=e.Actual(t);return e.Message((function(t){let i=null;e.ExecutorApplied(r,(t=>e=>{i&&clearTimeout(i),i=setTimeout((()=>{t(e)}),n)})).then(t)}))},t.Template=function(t="",n=e.Of({})){const r=e.Late();("string"==typeof t||e.isMessage(t))&&r.chain(e.Actual(t));const i=new l(r,n?e.Actual(n):void 0);return"function"==typeof t&&r.chain(e.Message((e=>{e(t(i))}))),i},t.TemplateImpl=l,t.Tick=function(t){return e.Message((function(e){let n=!1,r=null;t.then((t=>{r=t,n||(n=!0,queueMicrotask((()=>{n=!1,null!==r&&(e(r),r=null)})))}))}))},t.ToJson=function(t){return e.Message((function(e,n){t.then((t=>{try{e(JSON.stringify(t))}catch{n(new Error("Failed to convert to JSON"))}}))}))},t.Transformed=o,t.TransformedList=function(t,n){return e.Map(e.Actual(t),(t=>o(t,n)))},t.escaped=h,t}({},silentium);
